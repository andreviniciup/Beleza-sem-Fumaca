{% extends "base.html" %}

{% block title %}Dashboard - Quiz Beleza sem Fuma칞a{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-100 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">游늵 Dashboard</h1>
            <p class="mt-2 text-gray-600">Dados do Quiz Beleza sem Fuma칞a</p>
        </div>

        <!-- Loading -->
        <div class="loading flex justify-center items-center py-8 hidden" id="loading">
            <div class="bg-white rounded-lg p-6 flex flex-col items-center">
                <div class="spinner-border w-8 h-8" role="status">
                    <span class="sr-only">Carregando...</span>
                </div>
                <p class="mt-3 text-sm text-gray-600">Carregando dados...</p>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="statsCards">
            <!-- Cards ser칚o inseridos via JavaScript -->
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                    <button class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 active" data-tab="resultados">
                        游늳 Resultados
                    </button>
                    <button class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="usuarios">
                        游논 Usu치rios
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                <!-- Resultados Tab -->
                <div id="resultados-tab" class="tab-content">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usu치rio</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acertos</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Brinde</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                </tr>
                            </thead>
                            <tbody id="resultados-table" class="bg-white divide-y divide-gray-200">
                                <!-- Dados ser칚o inseridos via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Usu치rios Tab -->
                <div id="usuarios-tab" class="tab-content hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Idade</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">G칡nero</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fonte</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                </tr>
                            </thead>
                            <tbody id="usuarios-table" class="bg-white divide-y divide-gray-200">
                                <!-- Dados ser칚o inseridos via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    carregarDados();
    setupTabs();
});

function setupTabs() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            
            // Remove active class from all buttons and contents
            tabButtons.forEach(btn => {
                btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            
            // Add active class to clicked button and show content
            this.classList.add('active', 'border-blue-500', 'text-blue-600');
            this.classList.remove('border-transparent', 'text-gray-500');
            
            document.getElementById(tabName + '-tab').classList.remove('hidden');
        });
    });
}

async function carregarDados() {
    try {
        mostrarLoading();
        
        // Carregar estat칤sticas
        const statsResponse = await fetch('/api/dados');
        const statsData = await statsResponse.json();
        
        if (statsResponse.ok) {
            mostrarStats(statsData);
            mostrarResultados(statsData.ultimos_resultados);
        } else {
            throw new Error(statsData.erro || 'Erro ao carregar estat칤sticas');
        }
        
        // Carregar usu치rios
        const usuariosResponse = await fetch('/api/usuarios');
        const usuariosData = await usuariosResponse.json();
        
        if (usuariosResponse.ok) {
            mostrarUsuarios(usuariosData);
        } else {
            throw new Error(usuariosData.erro || 'Erro ao carregar usu치rios');
        }
        
        esconderLoading();
        
    } catch (error) {
        console.error('Erro ao carregar dados:', error);
        esconderLoading();
        mostrarErro(error.message);
    }
}

function mostrarStats(data) {
    const statsCards = document.getElementById('statsCards');
    
    statsCards.innerHTML = `
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                            <span class="text-white text-sm font-medium">游논</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Total de Usu치rios</dt>
                            <dd class="text-lg font-medium text-gray-900">${data.total_usuarios}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                            <span class="text-white text-sm font-medium">游늵</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Total de Resultados</dt>
                            <dd class="text-lg font-medium text-gray-900">${data.total_resultados}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
                            <span class="text-white text-sm font-medium">游꾸</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Ganhadores</dt>
                            <dd class="text-lg font-medium text-gray-900">${data.ganhadores}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-purple-500 rounded-md flex items-center justify-center">
                            <span class="text-white text-sm font-medium">游늳</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">M칠dia de Acertos</dt>
                            <dd class="text-lg font-medium text-gray-900">${data.media_acertos}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function mostrarResultados(resultados) {
    const tbody = document.getElementById('resultados-table');
    
    if (resultados.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                    Nenhum resultado encontrado
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = resultados.map(resultado => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${resultado.id}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${resultado.usuario_id}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${resultado.total_acertos}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${resultado.total_questoes}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${resultado.ganhou_brinde ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                    ${resultado.ganhou_brinde ? 'Sim' : 'N칚o'}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${resultado.data_resultado || 'N/A'}</td>
        </tr>
    `).join('');
}

function mostrarUsuarios(usuarios) {
    const tbody = document.getElementById('usuarios-table');
    
    if (usuarios.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                    Nenhum usu치rio encontrado
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = usuarios.map(usuario => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${usuario.id}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${usuario.nome}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${usuario.idade}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${usuario.genero}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${usuario.fonte_conhecimento}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${usuario.data_cadastro || 'N/A'}</td>
        </tr>
    `).join('');
}

function mostrarLoading() {
    const loading = document.getElementById('loading');
    loading.classList.remove('hidden');
}

function esconderLoading() {
    const loading = document.getElementById('loading');
    loading.classList.add('hidden');
}

function mostrarErro(mensagem) {
    // Implementar exibi칞칚o de erro se necess치rio
    console.error('Erro:', mensagem);
}
</script>
{% endblock %}
