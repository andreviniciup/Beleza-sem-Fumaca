{% extends "base.html" %}

{% block title %}Quiz Beleza sem Fuma√ßa - Resultado{% endblock %}

{% block content %}
<div class="w-full h-screen flex justify-center items-center overflow-hidden" id="resultadoContainer">
    <!-- Conte√∫do ser√° inserido via JavaScript -->
</div>

<!-- Loading -->
<div class="loading fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden" id="loading">
    <div class="bg-white rounded-lg p-6 flex flex-col items-center">
        <div class="spinner-border w-8 h-8" role="status">
            <span class="sr-only">Carregando...</span>
        </div>
        <p class="mt-3 text-sm text-text-light">Carregando resultado...</p>
    </div>
</div>

<!-- Erro -->
<div class="alert alert-danger fixed top-4 left-4 right-4 z-50" id="erro" style="display: none;">
    <div class="flex items-center">
        <i class="fas fa-exclamation-circle mr-2"></i>
        <span id="mensagemErro" class="text-sm"></span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('P√°gina de resultado carregada, buscando dados...');
    
    // Carregar sons primeiro
    carregarSons();
    
    // Simular intera√ß√£o do usu√°rio para habilitar autoplay
    simularInteracaoUsuario();
    
    // Depois carregar resultado
    carregarResultado();
});

// Fun√ß√£o para simular intera√ß√£o do usu√°rio
function simularInteracaoUsuario() {
    // Estrat√©gia 1: Adicionar event listeners para intera√ß√µes
    document.addEventListener('click', function() {
        console.log('‚úÖ Intera√ß√£o do usu√°rio detectada - autoplay habilitado');
        autoplayHabilitado = true;
        
        // Se j√° temos resultado, tocar som imediatamente
        if (resultadoCarregado !== null) {
            tocarSom(resultadoCarregado);
        }
    }, { once: true });
    
    document.addEventListener('touchstart', function() {
        console.log('‚úÖ Touch detectado - autoplay habilitado');
        autoplayHabilitado = true;
        
        // Se j√° temos resultado, tocar som imediatamente
        if (resultadoCarregado !== null) {
            tocarSom(resultadoCarregado);
        }
    }, { once: true });
    
    // Estrat√©gia 2: Tentar tocar um som silencioso para "ativar" o contexto de √°udio
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        gainNode.gain.setValueAtTime(0, audioContext.currentTime); // Volume 0
        oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.001);
        
        console.log('‚úÖ Contexto de √°udio ativado');
    } catch (error) {
        console.log('‚ö†Ô∏è N√£o foi poss√≠vel ativar contexto de √°udio:', error.message);
    }
}

// Fun√ß√£o para mostrar loading
function mostrarLoading() {
    console.log('Mostrando loading...');
    const loading = document.getElementById('loading');
    loading.classList.remove('hidden');
    loading.style.display = 'flex';
}

// Fun√ß√£o para esconder loading
function esconderLoading() {
    console.log('Escondendo loading...');
    const loading = document.getElementById('loading');
    loading.classList.add('hidden');
    loading.style.display = 'none';
}

async function carregarResultado() {
    try {
        console.log('Fazendo requisi√ß√£o para /api/obter_resultado...');
        mostrarLoading();
        
        const response = await fetch('/api/obter_resultado');
        const data = await response.json();
        
        console.log('Response status:', response.status);
        console.log('Dados do resultado:', data);
        
        if (response.ok) {
            esconderLoading();
            mostrarResultado(data);
        } else {
            throw new Error(data.erro || 'Erro ao carregar resultado');
        }
    } catch (error) {
        console.error('Erro ao carregar resultado:', error);
        esconderLoading();
        mostrarErro(error.message);
    }
}

function mostrarResultado(data) {
    const container = document.getElementById('resultadoContainer');
    const acertos = data.acertos;
    const total = data.total;
    const ganhouBrinde = data.ganhou_brinde;
    
    console.log(`Mostrando resultado: ${acertos}/${total} acertos, ganhou brinde: ${ganhouBrinde}`);
    
    // Salvar resultado para tocar som quando autoplay for habilitado
    resultadoCarregado = ganhouBrinde;
    
    // Tocar som baseado no resultado (se autoplay j√° estiver habilitado)
    if (autoplayHabilitado) {
        tocarSom(ganhouBrinde);
    } else {
        // Tentar tocar automaticamente ap√≥s um delay
        setTimeout(() => {
            if (!autoplayHabilitado) {
                console.log('üéµ Tentando autoplay ap√≥s delay...');
                tocarSom(ganhouBrinde);
            }
        }, 500);
    }
    
    if (ganhouBrinde) {
        // Layout para quem ganhou brinde
        container.innerHTML = `
            <div class="w-full h-full bg-[#446A46] flex justify-center items-center overflow-hidden">
                <div class="w-full max-w-[338px] flex flex-col justify-start items-start gap-5 px-4">
                    <!-- Score -->
                    <div class="flex justify-start items-end gap-[5px]">
                        <div class="text-center text-white text-[128px] font-alexandria font-medium leading-none">${acertos}</div>
                        <div class="w-[120px] text-white text-base font-alexandria font-medium">acertos de ${total} quest√µes</div>
                    </div>
                    
                    <!-- Mensagem de parab√©ns -->
                    <div class="w-full flex flex-col justify-start items-start">
                        <div class="w-full text-white text-[40px] font-alexandria font-medium">PARAB√âNS!</div>
                        <div class="w-full text-center text-white text-xl font-alexandria font-medium">Voc√™ ganhou um brinde especial!</div>
                    </div>
                </div>
            </div>
        `;
    } else {
        // Layout para quem n√£o ganhou brinde
        container.innerHTML = `
            <div class="w-full h-full bg-[#8D494A] flex justify-center items-center overflow-hidden">
                <div class="w-full max-w-[338px] flex flex-col justify-start items-start gap-[21px] px-4">
                    <!-- Score -->
                    <div class="flex justify-start items-end gap-[5px]">
                        <div class="text-center text-white text-[128px] font-alexandria font-medium leading-none">${acertos}</div>
                        <div class="w-[120px] text-white text-base font-alexandria font-medium">acertos de ${total} quest√µes</div>
                    </div>
                    
                    <!-- Mensagem de agradecimento -->
                    <div class="w-full flex flex-col justify-start items-start">
                        <div class="w-full text-white text-xl font-alexandria font-medium leading-relaxed">
                            Obrigado por participar!<br/>
                            Dessa vez n√£o tem brinde :(<br/><br/>
                            mas voc√™ j√° saiu ganhando com mais conhecimento.
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
}

// Vari√°veis globais para √°udio
let audioVictory = null;
let audioDefeat = null;
let somCarregado = false;
let resultadoCarregado = null;
let autoplayHabilitado = false;

// Fun√ß√£o para detectar se √© mobile
function isMobile() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

// Fun√ß√£o para carregar os sons
function carregarSons() {
    try {
        // Criar elementos de √°udio
        audioVictory = new Audio('/static/sounds/victory.mp3');
        audioDefeat = new Audio('/static/sounds/defeat.mp3');
        
        // Configurar volume
        audioVictory.volume = 0.7;
        audioDefeat.volume = 0.7;
        
        // Pr√©-carregar os sons
        audioVictory.load();
        audioDefeat.load();
        
        somCarregado = true;
        console.log('‚úÖ Sons carregados com sucesso!');
        
    } catch (error) {
        console.log('‚ö†Ô∏è Erro ao carregar sons:', error.message);
    }
}

// Fun√ß√£o para tocar som
function tocarSom(ganhouBrinde) {
    if (!somCarregado) {
        console.log('‚ö†Ô∏è Sons n√£o carregados ainda');
        return;
    }
    
    try {
        const audio = ganhouBrinde ? audioVictory : audioDefeat;
        
        if (audio) {
            // Reset para o in√≠cio
            audio.currentTime = 0;
            
            // Configura√ß√µes para for√ßar autoplay
            audio.muted = false;
            audio.autoplay = true;
            audio.preload = 'auto';
            
            // Tentar tocar com m√∫ltiplas estrat√©gias
            const playPromise = audio.play();
            
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    console.log(ganhouBrinde ? 'üéâ Som de vit√≥ria tocado!' : 'üòî Som de derrota tocado!');
                }).catch(error => {
                    console.log('‚ö†Ô∏è Primeira tentativa falhou:', error.message);
                    
                    // Segunda tentativa: com intera√ß√£o simulada
                    setTimeout(() => {
                        tentarTocarSom(audio, ganhouBrinde);
                    }, 100);
                });
            }
        }
        
    } catch (error) {
        console.log('‚ö†Ô∏è Erro ao configurar som:', error.message);
    }
}

// Fun√ß√£o para tentar tocar som com diferentes estrat√©gias
function tentarTocarSom(audio, ganhouBrinde) {
    // Estrat√©gia 1: Tentar novamente
    audio.play().then(() => {
        console.log(ganhouBrinde ? 'üéâ Som de vit√≥ria tocado (2¬™ tentativa)!' : 'üòî Som de derrota tocado (2¬™ tentativa)!');
    }).catch(error => {
        console.log('‚ö†Ô∏è Segunda tentativa falhou:', error.message);
        
        // Estrat√©gia 2: Tentar com volume 0 e depois aumentar
        audio.volume = 0;
        audio.play().then(() => {
            audio.volume = 0.7;
            console.log(ganhouBrinde ? 'üéâ Som de vit√≥ria tocado (3¬™ tentativa)!' : 'üòî Som de derrota tocado (3¬™ tentativa)!');
        }).catch(error => {
            console.log('‚ö†Ô∏è Terceira tentativa falhou:', error.message);
            
            // Estrat√©gia 3: Tentar com muted e depois desmutar
            audio.muted = true;
            audio.play().then(() => {
                audio.muted = false;
                console.log(ganhouBrinde ? 'üéâ Som de vit√≥ria tocado (4¬™ tentativa)!' : 'üòî Som de derrota tocado (4¬™ tentativa)!');
            }).catch(error => {
                console.log('‚ö†Ô∏è Todas as tentativas falharam:', error.message);
                
                // √öltima tentativa: mostrar bot√£o apenas se for mobile
                if (isMobile()) {
                    mostrarBotaoSom(ganhouBrinde);
                }
            });
        });
    });
}

// Fun√ß√£o para mostrar bot√£o de som no mobile
function mostrarBotaoSom(ganhouBrinde) {
    const container = document.getElementById('resultadoContainer');
    const botaoSom = document.createElement('button');
    
    botaoSom.innerHTML = `
        <div class="fixed bottom-4 right-4 bg-white bg-opacity-90 rounded-full p-3 shadow-lg z-50">
            <div class="text-center">
                <div class="text-2xl">üîä</div>
                <div class="text-xs text-gray-600 mt-1">Tocar Som</div>
            </div>
        </div>
    `;
    
    botaoSom.addEventListener('click', function() {
        tocarSom(ganhouBrinde);
        botaoSom.remove();
    });
    
    container.appendChild(botaoSom);
    
    // Remover bot√£o ap√≥s 10 segundos
    setTimeout(() => {
        if (botaoSom.parentNode) {
            botaoSom.remove();
        }
    }, 10000);
}

function mostrarErro(mensagem) {
    const erro = document.getElementById('erro');
    const mensagemErro = document.getElementById('mensagemErro');
    
    console.error('Erro:', mensagem);
    
    mensagemErro.textContent = mensagem;
    erro.style.display = 'block';
    
    // Esconder ap√≥s 5 segundos
    setTimeout(() => {
        erro.style.display = 'none';
    }, 5000);
}
</script>
{% endblock %}
