{% extends "base.html" %}

{% block title %}Quiz Beleza sem Fumaça - Cadastro{% endblock %}

{% block content %}
<div class="w-full min-h-screen gradient-bg flex justify-start items-center px-2.5 py-[142px] pb-[92px] overflow-hidden">
    <div class="w-full max-w-[370px] flex flex-col items-center gap-[266px]">
        <!-- Conteúdo do formulário -->
        <div class="w-full flex flex-col items-center gap-[17px]">
            <!-- Título -->
            <div class="w-full p-2.5 flex justify-center items-center">
                <div class="w-[350px] text-center text-white text-xl font-alexandria font-medium">
                    Antes de começar, me fale rapidinho algumas informações:
                </div>
            </div>
            
            <!-- Campos do formulário -->
            <div class="w-[350px] flex flex-col items-start gap-[30px]">
                <!-- Nome -->
                <div class="w-full flex flex-col items-start gap-[5px]">
                    <div class="w-full text-white text-base font-alexandria font-medium">
                        Nome
                    </div>
                    <input type="text" 
                           class="w-full h-[40px] bg-text-light rounded-[15px] px-4 text-secondary font-alexandria focus:outline-none focus:ring-2 focus:ring-primary" 
                           id="nome" 
                           name="nome" 
                           required>
                </div>
                
                <!-- Idade e Gênero (lado a lado) -->
                <div class="w-full flex justify-start items-center gap-[30px]">
                    <!-- Idade -->
                    <div class="w-[160px] flex flex-col items-start gap-[5px]">
                        <div class="w-full text-white text-base font-alexandria font-medium">
                            Idade
                        </div>
                        <input type="number" 
                               class="w-full h-[40px] bg-text-light rounded-[15px] px-4 text-secondary font-alexandria focus:outline-none focus:ring-2 focus:ring-primary" 
                               id="idade" 
                               name="idade" 
                               min="1" 
                               max="120" 
                               required>
                    </div>
                    
                    <!-- Gênero -->
                    <div class="w-[160px] flex flex-col items-start gap-[5px]">
                        <div class="w-full text-white text-base font-alexandria font-medium">
                            Gênero
                        </div>
                        <select class="w-full h-[40px] bg-text-light rounded-[15px] px-4 text-secondary font-alexandria focus:outline-none focus:ring-2 focus:ring-primary" 
                                id="genero" 
                                name="genero" 
                                required>
                            <option value="">Selecione...</option>
                            <option value="Feminino">Feminino</option>
                            <option value="Masculino">Masculino</option>
                            <option value="Não-binário">Não-binário</option>
                            <option value="Prefiro não informar">Prefiro não informar</option>
                        </select>
                    </div>
                </div>
                
                <!-- Fonte de conhecimento -->
                <div class="w-full flex flex-col items-start gap-[5px]">
                    <div class="w-full text-white text-base font-alexandria font-medium">
                        Onde você ficou sabendo da ação?
                    </div>
                    <select class="w-full h-[40px] bg-text-light rounded-[15px] px-4 text-secondary font-alexandria focus:outline-none focus:ring-2 focus:ring-primary" 
                            id="fonte_conhecimento" 
                            name="fonte_conhecimento" 
                            required>
                        <option value="">Selecione...</option>
                        <option value="Instagram">Instagram</option>
                        <option value="WhatsApp">WhatsApp</option>
                        <option value="Indicação de amigo">Indicação de amigo</option>
                        <option value="Faculdade">Faculdade</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Botão -->
        <button type="button" 
                class="w-[330px] px-12 py-2.5 bg-primary rounded-[20px] flex justify-center items-center transition-all duration-300 hover:bg-[#A05A7A] hover:transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed" 
                id="btnEnviar" 
                disabled>
            <div class="text-center text-white text-xl font-alexandria font-medium">
                Começar Quiz
            </div>
        </button>
    </div>
</div>

<!-- Loading -->
<div class="loading fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden" id="loading">
    <div class="bg-white rounded-lg p-6 flex flex-col items-center">
        <div class="spinner-border w-8 h-8" role="status">
            <span class="sr-only">Carregando...</span>
        </div>
        <p class="mt-3 text-sm text-text-light">Cadastrando seus dados...</p>
    </div>
</div>

<!-- Erro -->
<div class="alert alert-danger fixed top-4 left-4 right-4 z-50" id="erro" style="display: none;">
    <div class="flex items-center">
        <i class="fas fa-exclamation-circle mr-2"></i>
        <span id="mensagemErro" class="text-sm"></span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btnEnviar = document.getElementById('btnEnviar');
    const loading = document.getElementById('loading');
    const erro = document.getElementById('erro');
    const mensagemErro = document.getElementById('mensagemErro');
    
    console.log('Página carregada, elementos encontrados:', {
        btnEnviar: !!btnEnviar,
        loading: !!loading,
        erro: !!erro,
        mensagemErro: !!mensagemErro
    });
    
    // Função para verificar se todos os campos estão preenchidos
    function verificarCampos() {
        const nome = document.getElementById('nome').value.trim();
        const idade = document.getElementById('idade').value;
        const genero = document.getElementById('genero').value;
        const fonte = document.getElementById('fonte_conhecimento').value;
        
        console.log('Verificando campos:', { nome, idade, genero, fonte });
        
        const todosPreenchidos = nome && idade && genero && fonte;
        btnEnviar.disabled = !todosPreenchidos;
        
        console.log('Botão habilitado:', !btnEnviar.disabled);
    }
    
    // Função para mostrar loading
    function mostrarLoading() {
        console.log('Mostrando loading...');
        loading.classList.remove('hidden');
        loading.style.display = 'flex';
    }
    
    // Função para esconder loading
    function esconderLoading() {
        console.log('Escondendo loading...');
        loading.classList.add('hidden');
        loading.style.display = 'none';
    }
    
    // Adicionar listeners para verificar campos
    document.getElementById('nome').addEventListener('input', verificarCampos);
    document.getElementById('idade').addEventListener('input', verificarCampos);
    document.getElementById('genero').addEventListener('change', verificarCampos);
    document.getElementById('fonte_conhecimento').addEventListener('change', verificarCampos);
    
    // Submissão do formulário
    btnEnviar.addEventListener('click', async function(e) {
        e.preventDefault();
        
        console.log('Botão clicado!');
        
        const data = {
            nome: document.getElementById('nome').value.trim(),
            idade: parseInt(document.getElementById('idade').value),
            genero: document.getElementById('genero').value,
            fonte_conhecimento: document.getElementById('fonte_conhecimento').value
        };
        
        console.log('Dados a serem enviados:', data);
        
        // Mostrar loading
        mostrarLoading();
        erro.style.display = 'none';
        
        try {
            console.log('Fazendo requisição para /api/cadastrar_usuario...');
            
            const response = await fetch('/api/cadastrar_usuario', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.log('Error response text:', errorText);
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            const result = await response.json();
            console.log('Response result:', result);
            
            if (result.sucesso) {
                console.log('Sucesso! Redirecionando para /quiz...');
                window.location.href = '/quiz';
            } else {
                throw new Error(result.erro || 'Erro desconhecido');
            }
            
        } catch (error) {
            console.error('Erro completo:', error);
            console.error('Erro message:', error.message);
            console.error('Erro stack:', error.stack);
            
            // Mostrar erro
            mensagemErro.textContent = error.message || 'Erro ao cadastrar usuário';
            erro.style.display = 'block';
            
            // Esconder loading
            esconderLoading();
        }
    });
    
    // Verificar campos inicialmente
    verificarCampos();
    
    // Garantir que o loading está escondido no início
    esconderLoading();
});
</script>
{% endblock %}
